# 内置指令选择器功能实现需求文档

## 项目背景
本项目是一个基于 Kotlin 的 Android 物联网设备管理应用，采用 MVVM 架构，使用 Room 数据库、Koin 依赖注入、Navigation 框架等技术栈。

## 技术架构信息
- **架构模式**: MVVM + DataBinding + Repository Pattern
- **数据库**: Room 数据库持久化
- **依赖注入**: Koin 框架
- **UI框架**: Fragment + Navigation + XPopup
- **编程语言**: Kotlin
- **基类体系**: BaseFragment -> BaseVmDbFragment

## 需求概述
在现有的 `BleCustomCommandLogPrintFragment` 页面中，添加"快捷发送指令"功能，实现内置指令的管理和快速发送。

## 具体实现需求

### 1. 数据模型设计
需要创建新的 Room 实体类来存储内置指令：

```kotlin
// 参考现有 LogSession 和 LogItem 的设计模式
@Entity(tableName = "builtin_commands")
data class BuiltinCommandEntity(
    @PrimaryKey val id: String,
    val category: String,      // 指令分类
    val name: String,          // 指令名称  
    val content: String,       // 指令内容
    val remark: String,        // 备注
    val createTime: Long,      // 创建时间
    val updateTime: Long       // 更新时间
)
```

### 2. 数据访问层（DAO）
参考现有的 `LogSessionDao` 和 `LogItemDao` 设计模式：

```kotlin
@Dao
interface BuiltinCommandDao {
    @Query("SELECT * FROM builtin_commands ORDER BY category, name")
    suspend fun getAllCommands(): List<BuiltinCommandEntity>
    
    @Insert(onConflict = OnConflictStrategy.REPLACE)
    suspend fun insertCommand(command: BuiltinCommandEntity)
    
    @Insert(onConflict = OnConflictStrategy.REPLACE)
    suspend fun batchInsert(commands: List<BuiltinCommandEntity>)
    
    @Delete
    suspend fun deleteCommands(commands: List<BuiltinCommandEntity>)
    
    @Query("DELETE FROM builtin_commands WHERE id IN (:ids)")
    suspend fun deleteByIds(ids: List<String>)
}
```

### 3. Repository 层
参考现有的 `LoggerRepositoryImp` 设计模式：

```kotlin
class BuiltinCommandRepository(
    private val builtinCommandDao: BuiltinCommandDao
) {
    suspend fun getAllCommands(): List<BuiltinCommandEntity> = 
        withContext(Dispatchers.IO) {
            builtinCommandDao.getAllCommands()
        }
    
    suspend fun saveCommand(command: BuiltinCommandEntity) = 
        withContext(Dispatchers.IO) {
            builtinCommandDao.insertCommand(command)
        }
    
    suspend fun importCommands(commands: List<BuiltinCommandEntity>) = 
        withContext(Dispatchers.IO) {
            builtinCommandDao.batchInsert(commands)
        }
    
    suspend fun deleteCommands(commands: List<BuiltinCommandEntity>) = 
        withContext(Dispatchers.IO) {
            builtinCommandDao.deleteCommands(commands)
        }
}
```

### 4. 主界面功能实现

#### 4.1 Menu 按钮实现
在现有的 `BleCustomCommandLogPrintFragment` 中，Menu 已经有 `R.id.action_builtin_cmd` 项，需要实现其点击事件：

```kotlin
R.id.action_builtin_cmd -> {
    // 导航到内置指令选择器页面
    val bundle = BuiltinCommandSelectorFragment.newBundleArguments(
        productType, communicateWay, deviceInfo, bleDevice
    )
    nav().safeNavigate(R.id.action_to_builtinCommandSelectorFragment, bundle)
    true
}
```

#### 4.2 内置指令选择器 Fragment
创建 `BuiltinCommandSelectorFragment`，参考现有的 Fragment 设计模式：

```kotlin
class BuiltinCommandSelectorFragment : BaseIOTDeviceFragment() {
    private lateinit var binding: FragmentBuiltinCommandSelectorBinding
    private val mStates: BuiltinCommandSelectorViewModel by viewModels()
    private val toolbarViewModel: ToolbarViewModel by viewModels()
    
    // 选择模式状态
    private var isSelectionMode = false
    private val selectedCommands = mutableListOf<BuiltinCommandEntity>()
    
    override fun getDataBindingConfig(): DataBindingConfig {
        return DataBindingConfig(
            R.layout.fragment_builtin_command_selector,
            BR.stateVM, mStates
        )
            .addBindingParam(BR.toolbarVM, toolbarViewModel)
            .addBindingParam(BR.click, ClickProxy())
    }
    
    // 实现具体的点击事件和业务逻辑
}
```

### 5. 界面交互需求

#### 5.1 列表展示
- 使用 RecyclerView + BRV 框架（项目已使用）
- 显示指令分类、名称、内容
- 每个列表项包含：复选框、指令信息、"发送" 按钮

#### 5.2 选择模式切换
- 点击复选框进入选择模式
- Toolbar 右侧隐藏 "添加"、"导入" 按钮，显示 "完成" 按钮
- 底部显示 "全选"、"删除" 按钮布局

#### 5.3 弹框设计
使用项目现有的弹框模式：
- **编辑弹框**: 使用 `CenterPopupView` 创建指令编辑弹框
- **选择弹框**: 使用 `XPopup.Builder(context).asBottomList()` 模式
- **确认弹框**: 使用 `showMessage()` 扩展函数

### 6. CSV 导入功能

``` CSV 指令模板文件内容示例
指令分类,指令名称,指令内容,备注
通用指令,获取工作模式,$cmd=getworkmode,无
通用指令,获取日志输出等级及输出方式,$cmd=md_getlogoutput,无
通用指令,获取设备状态,$cmd=getstatus,无
MR702|MR701|M50,报警参数查询,$cmd=md_getalarmmodule&index=1,无
```

#### 6.1 文件选择
```kotlin
private fun importFromCSV() {
    val intent = Intent(Intent.ACTION_GET_CONTENT).apply {
        type = "text/csv"
        addCategory(Intent.CATEGORY_OPENABLE)
    }
    startActivityForResult(intent, REQUEST_CODE_IMPORT_CSV)
}
```

#### 6.2 CSV 解析
```kotlin
private suspend fun parseCSVFile(uri: Uri): List<BuiltinCommandEntity> {
    return withContext(Dispatchers.IO) {
        try {
            val inputStream = requireContext().contentResolver.openInputStream(uri)
            val reader = BufferedReader(InputStreamReader(inputStream))
            val commands = mutableListOf<BuiltinCommandEntity>()
            
            reader.useLines { lines ->
                lines.drop(1).forEach { line -> // 跳过标题行
                    val parts = line.split(",")
                    if (parts.size >= 3) {
                        commands.add(
                            BuiltinCommandEntity(
                                id = UUID.randomUUID().toString(),
                                category = parts[0].trim(),
                                name = parts[1].trim(),
                                content = parts[2].trim(),
                                remark = parts.getOrNull(3)?.trim() ?: "",
                                createTime = System.currentTimeMillis(),
                                updateTime = System.currentTimeMillis()
                            )
                        )
                    }
                }
            }
            commands
        } catch (e: Exception) {
            Timber.e(e, "CSV文件解析失败")
            emptyList()
        }
    }
}
```

### 7. 指令发送集成
发送指令时，需要与现有的 `BleCustomCommandLogPrintFragment` 的发送逻辑集成：

```kotlin
private fun sendCommand(command: BuiltinCommandEntity) {
    // 设置返回结果，让 BleCustomCommandLogPrintFragment 处理发送
    val resultBundle = Bundle().apply {
        putString("command_content", command.content)
        putString("command_name", command.name)
    }
    setFragmentResult("builtin_command_selected", resultBundle)
    nav().navigateUp()
}
```

### 8. 数据库迁移
需要更新 `AppDatabase` 版本并添加迁移：

```kotlin
@Database(
    entities = [/*现有实体*/, BuiltinCommandEntity::class],
    version = 3, // 从当前版本2升级到3
    exportSchema = true
)
abstract class AppDatabase : RoomDatabase() {
    abstract fun builtinCommandDao(): BuiltinCommandDao
    
    companion object {
        val MIGRATION_2_3: Migration = object : Migration(2, 3) {
            override fun migrate(database: SupportSQLiteDatabase) {
                database.execSQL("""
                    CREATE TABLE IF NOT EXISTS builtin_commands (
                        id TEXT PRIMARY KEY NOT NULL,
                        category TEXT NOT NULL,
                        name TEXT NOT NULL,
                        content TEXT NOT NULL,
                        remark TEXT  NULL,
                        create_time INTEGER NOT NULL,
                        update_time INTEGER NOT NULL
                    )
                """)
            }
        }
    }
}
```

### 9. Koin 依赖注入配置
需要在相应的 Koin 模块中添加依赖：

```kotlin
val databaseModule = module {
    // 现有配置...
    single { get<AppDatabase>().builtinCommandDao() }
}

val repositoryModule = module {
    // 现有配置...
    single { BuiltinCommandRepository(get()) }
}

val viewModelModule = module {
    // 现有配置...
    viewModelOf(::BuiltinCommandSelectorViewModel)
}
```

### 10. 错误处理和用户体验
- 使用 `try-catch` 包装所有异步操作
- 使用 `Timber.e()` 记录错误日志
- 使用 `Toaster.show()` 显示用户友好的错误提示
- 添加加载状态指示器
- 实现数据校验和空状态处理

### 11. 测试要求
- 单元测试：Repository 层的数据操作
- UI 测试：Fragment 的界面交互
- 集成测试：CSV 导入和指令发送功能
- 边界测试：大量数据导入和异常情况处理

## 实现优先级
1. **P0**: 基本的 CRUD 功能和指令发送
2. **P1**: CSV 导入功能和批量操作
3. **P2**: 界面优化和用户体验提升

## 技术约束
- 必须遵循项目现有的代码风格和架构模式
- 使用项目现有的UI组件和设计语言
- 确保与现有功能的兼容性
- 优先使用协程进行异步操作
- 必须添加完善的错误处理和日志记录



### 竞品 APP 参考界面截图
![快捷指令页面](https://i.postimg.cc/ydv9ncqy/image.jpg)  
* 默认状态 *

![快捷指令页面](https://i.postimg.cc/MG01Mgd4/image.jpg)
* 快捷指令页面 *

![快捷指令页面](https://i.postimg.cc/pT2zDkSd/image.jpg)
* 编辑指令弹框 *






