# 1 Android 物联网设备数据传输与导出完整实现方案

## 项目背景
基于现有的 mCloudapp_V5 Android 项目，实现物联网设备历史监测数据的完整传输链路：**设备蓝牙传输 → 本地存储 → Excel导出**。

## 现有技术栈能力评估

### ✅ 已具备的核心能力
1. **BLE通信框架**（`lib_ble`模块）
   - MTU优化：512字节
   - 自动分片：Nordic BLE库 `.split()` 功能
   - 数据合并：`PacketMerger` 处理接收数据
   - 设备管理：`MedoBleManager` 和 `BleViewModel`

2. **数据存储架构**（`core_data`模块）
   - Room数据库本地持久化
   - 完整的数据层架构

3. **基础导出功能**
   - 已实现：`LogDataFragment.shareLogToFile()`

## 具体需求规格

### 数据查询协议
``` 查询指令
$cmd=md_getsensordata&begin=20250101120000&end=20250708120000&currentPage=1&apikey=123456&msgid=123456
```

``` 响应成功
$cmd=md_getsensordata&totalCount=10&totalPage=5&pageSize=2&currentPageData=[{"timeStr": "2025-07-07 15:00:29","content": "{\"222_11\":{\"2025-07-07 16:17:12\":\"-1355.779,0.000\"}}"},
{"timeStr": "2025-07-07 16:15:30","content": "{\"222_2\":{\"2025-07-07 16:17:12\":\"-2073.909,0.000\"}}"}]&result=succ&apikey=123456&msgid=123456
```

``` 响应失败
$cmd=md_getsensordata&result=fail&reason=type-param_invalid&apikey=95b00bdc-4ecd-4772-aaca-17fd7079decd&msgid=451efc
```

### Excel导出格式要求
| 设备编号 | 时间 | 传感器数据内容 | 备注 |
|---------|------|----------|--------|
| 243063L |  2025-07-07 15:00:29 | 	{"222_11":{"2025-07-07 16:17:12":"-1355.779,0.000"}} | |

### 技术实现要求

#### 架构模式
- 遵循 **MVVM + Repository** 架构
- 使用 **Kotlin Coroutines** 处理异步操作
- 采用 **Clean Architecture** 分层设计

#### 性能和用户体验要求
1. **传输优化**
   - 支持断点续传
   - 智能重传机制（指数退避）

2. **内存管理**
   - 流式处理大数据，避免OOM
   - 及时释放已处理数据的内存

3. **用户界面**
   - 实时传输进度显示（百分比、速度、预计剩余时间）
   - 后台传输时显示通知

4. **期望的代码风格**
- 使用 Kotlin 协程而非回调
- 完善的错误处理和日志记录
- 清晰的注释和文档
- 遵循 Clean Code 原则


### 基本使用流程

1. **蓝牙通讯下进入设备设置页面(BaseAdvancedSettingFragment)**
2. **点击"监测数据导出"功能模块**
3. **点击"开始传输"按钮启动蓝牙数据传输**
4. **实时查看传输进度和状态**
5. **传输完成后点击"导出Excel文件"**
6. **选择分享方式分享导出的Excel文件**

### 功能特性

- ✅ **大文件传输支持**：支持十几MB数据的稳定传输
- ✅ **数据查询**：支持按照时间范围查询设备存储的业务数据
- ✅ **实时进度显示**：显示传输速度、剩余时间等详细信息
- ✅ **断点续传**：传输过程可中断和恢复
- ✅ **错误重试**：自动重试机制保证传输可靠性
- ✅ **本地存储**：自动保存到本地数据库
- ✅ **Excel导出**：支持Excel文件导出
- ✅ **文件分享**：一键分享导出的Excel文件
- ✅ 内存使用合理，无OOM


# 2 Android 物联网设备数据传输与导出需求变更

## 数据查询协议
``` 查询指令
$cmd=md_getsensordata&begin=20250101120000&end=20250708120000&apikey=123456&msgid=123456
```

``` 响应成功
$cmd=md_getsensordata&datastreams=[{"222_2":{"2025-07-01 07:55:25":"-2073.765,0.000"}},{"222_11":{"2025-07-01 07:55:25":"-1355.635,0.000"}},{"222_1":{"2025-07-01 08:05:21":"-2468.713,0.000"}},{"222_1":{"2025-07-01 08:15:17":"-2468.569,0.000"}}{"103_5":{"2025-07-06 23:00:00":"0.835,-0.009,0.540,57.106,0.509,-32.935"}}]&apikey=123456&msgid=123456
```

``` 响应失败
$cmd=md_getsensordata&result=fail&reason=type-param_invalid&apikey=95b00bdc-4ecd-4772-aaca-17fd7079decd&msgid=451efc
```

## Excel导出格式要求
| 设备编号 | 时间 | 传感器数据内容 | 备注 |
|---------|------|----------|--------|
| 243063L |  2025-07-01 07:55:25 | 	{"222_2":{"2025-07-01 07:55:25":"-2073.765,0.000"}} | 传感器数据内容为 json 格式，格式为 {"传感器编号":{"时间":"数据值"}} |

## 数据导出需求变更点
1. **指令协议变更**
   - 正确解析指令中的datastreams=[]的 json 格式，datastreams 中的数据为 json 格式，格式为 {"传感器编号":{"时间":"数据值"}}，datastreams 中的 json 数组按照时间顺序排序，时间格式为 yyyy-MM-dd HH:mm:ss
   
   - MonitoringDataTransferManager 中的 buildQueryCommand 方法中组装查询指令时，需要动态更新起始时间参数 begin
      - begin 和 end 参数的初始值分别为 MonitoringDataExportFragment 中设置的开始时间和结束时间
      - 当指令响应成功返回 datastreams 数据时，需要更新 begin 参数为 datastreams 数据中的时间戳最大值

2. **实时进度显示**
    - 在 MonitoringDataExportFragment "数据信息"卡片中增加一项"已传输数据大小"，实时显示已传输数据大小。
      - 已传输数据小于 1024 字节，单位为 B。
      - 已传输数据大于 1024 字节，单位为 KB。
      - 已传输数据大于 1024 * 1024 字节，单位为 MB。
    
    - 在 MonitoringDataExportFragment 中取消"传输进度"卡片中的"页数"和"剩余时间"，因为这两个数据现在无法确定。 



# 3 优化

请你实现  MonitoringDataTransferManager 中的 generateMockResponse 方法，生成一个 mock 响应：
- 完整指令响应格式为：$cmd=md_getsensordata&readend=true&datastreams=[{"222_2":{"2025-07-01 07:55:25":"-2073.765,0.000"}},{"222_11":{"2025-07-01 07:55:25":"-1355.635,0.000"}},{"222_1":{"2025-07-01 08:05:21":"-2468.713,0.000"}},{"222_1":{"2025-07-01 08:15:17":"-2468.569,0.000"}}{"103_5":{"2025-07-06 23:00:00":"0.835,-0.009,0.540,57.106,0.509,-32.935"}}]&apikey=123456&msgid=123456

- datastreams 格式为 {{"传感器编号":{"时间":"数据值"},{"传感器编号":{"时间":"数据值"},{"传感器编号":{"时间":"数据值"}} 
  - datastreams 包含 10 个 {"传感器编号":{"时间":"数据值"}
  - 传感器编号为 222_2 格式，带下划线，使用随机数生成，传感器编号可以重复。
  - "时间" 为 yyyy-MM-dd HH:mm:ss 格式，使用系统当前时间
  - "数据值" 为 数据值，数据值为 3 个浮点数，用逗号分隔，格式为 "数据值1,数据值2,数据值3"







