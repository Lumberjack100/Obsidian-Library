<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GNSS卫星星空图 - 可视化分析工具</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'gps': '#22c55e',
                        'beidou': '#ef4444',
                        'glonass': '#3b82f6',
                        'galileo': '#f97316',
                        'dark-bg': '#0d1117',
                        'dark-card': '#161b22',
                        'dark-border': '#30363d',
                    },
                    fontFamily: {
                        'sans': ['SF Pro Display', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes pulse-soft {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .animate-fade-in-up { animation: fadeInUp 0.6s ease-out forwards; }
        .animate-delay-100 { animation-delay: 0.1s; }
        .animate-delay-200 { animation-delay: 0.2s; }
        .animate-delay-300 { animation-delay: 0.3s; }
        .animate-delay-400 { animation-delay: 0.4s; }
        .animate-spin { animation: spin 1s linear infinite; }
        
        .card-hover {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }
        
        .dark .card-hover:hover {
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
        }
        
        .satellite-dot { animation: pulse-soft 2s ease-in-out infinite; }
        
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #374151; }
        
        .gradient-text {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .dark .gradient-text {
            background: linear-gradient(135deg, #a5b4fc 0%, #c4b5fd 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .table-row-hover { transition: background-color 0.2s ease; }
        .table-row-hover:hover { background-color: rgba(99, 102, 241, 0.08); }
        .dark .table-row-hover:hover { background-color: rgba(99, 102, 241, 0.15); }
        
        /* Upload Zone Styles */
        .upload-zone {
            border: 2px dashed #d1d5db;
            transition: all 0.3s ease;
        }
        .upload-zone:hover, .upload-zone.drag-over {
            border-color: #6366f1;
            background-color: rgba(99, 102, 241, 0.05);
        }
        .dark .upload-zone { border-color: #4b5563; }
        .dark .upload-zone:hover, .dark .upload-zone.drag-over {
            border-color: #818cf8;
            background-color: rgba(99, 102, 241, 0.1);
        }
        
        /* Timeline Slider */
        .timeline-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: linear-gradient(to right, #6366f1 0%, #d1d5db 0%);
            outline: none;
        }
        .timeline-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #6366f1;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(99, 102, 241, 0.4);
            transition: transform 0.2s;
        }
        .timeline-slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
        }
        .dark .timeline-slider {
            background: linear-gradient(to right, #818cf8 0%, #374151 0%);
        }
        .dark .timeline-slider::-webkit-slider-thumb {
            background: #818cf8;
        }
        
        /* Analysis Card */
        .analysis-card {
            position: relative;
            overflow: hidden;
        }
        .analysis-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
        }
        .analysis-card.warning::before { background: #f59e0b; }
        .analysis-card.error::before { background: #ef4444; }
        .analysis-card.success::before { background: #22c55e; }
        .analysis-card.info::before { background: #3b82f6; }
        
        /* Trend Chart */
        .trend-line {
            stroke-width: 2;
            fill: none;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        
        /* Mode Toggle */
        .mode-toggle {
            position: relative;
            background: #e5e7eb;
            border-radius: 9999px;
            padding: 4px;
        }
        .dark .mode-toggle { background: #374151; }
        .mode-toggle-btn {
            position: relative;
            z-index: 1;
            padding: 6px 16px;
            border-radius: 9999px;
            font-size: 14px;
            font-weight: 500;
            transition: color 0.3s;
        }
        .mode-toggle-btn.active { color: white; }
        .mode-toggle-indicator {
            position: absolute;
            top: 4px;
            height: calc(100% - 8px);
            background: #6366f1;
            border-radius: 9999px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .dark .mode-toggle-indicator { background: #818cf8; }
        
        /* Common Satellite Badge */
        .common-sat {
            box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.5);
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-dark-bg text-gray-900 dark:text-gray-100 min-h-screen transition-colors duration-300">
    <!-- Header -->
    <header class="sticky top-0 z-50 bg-white/80 dark:bg-dark-bg/80 backdrop-blur-lg border-b border-gray-200 dark:border-dark-border">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center">
                        <i class="fas fa-satellite text-white text-lg"></i>
                    </div>
                    <div>
                        <h1 class="text-lg font-semibold">GNSS 卫星星空图</h1>
                        <p class="text-xs text-gray-500 dark:text-gray-400">可视化分析工具</p>
                    </div>
                </div>
                <button id="themeToggle" class="p-2.5 rounded-xl bg-gray-100 dark:bg-dark-card hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
                    <i class="fas fa-sun text-amber-500 dark:hidden"></i>
                    <i class="fas fa-moon text-indigo-400 hidden dark:block"></i>
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Hero Section -->
        <section class="text-center mb-8 opacity-0 animate-fade-in-up">
            <h2 class="text-3xl sm:text-4xl font-bold mb-4">
                <span class="gradient-text">理解卫星定位</span>，分析设备问题
            </h2>
            <p class="text-gray-600 dark:text-gray-400 max-w-2xl mx-auto text-lg">
                上传 RTCM3 二进制数据文件，可视化分析卫星信号质量，快速诊断定位问题
            </p>
        </section>

        <!-- Concepts Section -->
        <section class="mb-8 opacity-0 animate-fade-in-up animate-delay-100">
            <div class="flex items-center gap-2 mb-6">
                <div class="w-8 h-8 rounded-lg bg-indigo-100 dark:bg-indigo-900/30 flex items-center justify-center">
                    <i class="fas fa-book-open text-indigo-600 dark:text-indigo-400"></i>
                </div>
                <h3 class="text-xl font-semibold">核心概念</h3>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- GNSS Card -->
                <div class="card-hover bg-white dark:bg-dark-card rounded-2xl p-6 border border-gray-200 dark:border-dark-border">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-emerald-400 to-cyan-500 flex items-center justify-center">
                            <i class="fas fa-globe text-white"></i>
                        </div>
                        <h4 class="font-semibold text-lg">GNSS</h4>
                    </div>
                    <p class="text-gray-600 dark:text-gray-400 text-sm leading-relaxed mb-4">
                        <strong>全球导航卫星系统</strong>的英文缩写。想象天上有四个"卫星网络公司"同时为您提供定位服务：
                    </p>
                    <div class="space-y-2 text-sm">
                        <div class="flex items-center gap-2">
                            <span class="w-3 h-3 rounded-full bg-gps"></span>
                            <span>GPS（美国）- 31颗卫星</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="w-3 h-3 rounded-full bg-beidou"></span>
                            <span>北斗（中国）- 46颗卫星</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="w-3 h-3 rounded-full bg-glonass"></span>
                            <span>GLONASS（俄罗斯）- 24颗卫星</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="w-3 h-3 rounded-full bg-galileo"></span>
                            <span>Galileo（欧洲）- 28颗卫星</span>
                        </div>
                    </div>
                </div>

                <!-- RTK Card -->
                <div class="card-hover bg-white dark:bg-dark-card rounded-2xl p-6 border border-gray-200 dark:border-dark-border">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-violet-400 to-purple-500 flex items-center justify-center">
                            <i class="fas fa-crosshairs text-white"></i>
                        </div>
                        <h4 class="font-semibold text-lg">RTK</h4>
                    </div>
                    <p class="text-gray-600 dark:text-gray-400 text-sm leading-relaxed mb-4">
                        <strong>实时动态差分技术</strong>。普通GPS精度约3-5米，而RTK可达到<strong class="text-purple-600 dark:text-purple-400">厘米级</strong>精度。
                    </p>
                    <div class="bg-purple-50 dark:bg-purple-900/20 rounded-xl p-4 text-sm">
                        <p class="text-gray-700 dark:text-gray-300">
                            <i class="fas fa-lightbulb text-amber-500 mr-2"></i>
                            <strong>原理比喻：</strong>就像有一个"校准站"帮您修正误差，让定位更精准。
                        </p>
                    </div>
                </div>

                <!-- 仰角/方位角 Card -->
                <div class="card-hover bg-white dark:bg-dark-card rounded-2xl p-6 border border-gray-200 dark:border-dark-border">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-amber-400 to-orange-500 flex items-center justify-center">
                            <i class="fas fa-compass text-white"></i>
                        </div>
                        <h4 class="font-semibold text-lg">仰角 & 方位角</h4>
                    </div>
                    <div class="space-y-4 text-sm">
                        <div>
                            <p class="font-medium text-gray-700 dark:text-gray-300 mb-1">仰角 (Elevation)</p>
                            <p class="text-gray-600 dark:text-gray-400">
                                卫星在天空中的"高度"。0°表示在地平线，90°表示在正头顶。
                                <span class="text-amber-600 dark:text-amber-400">仰角越高，信号通常越好。</span>
                            </p>
                        </div>
                        <div>
                            <p class="font-medium text-gray-700 dark:text-gray-300 mb-1">方位角 (Azimuth)</p>
                            <p class="text-gray-600 dark:text-gray-400">
                                卫星在哪个方向。0°/360°是正北，90°是正东，180°是正南，270°是正西。
                            </p>
                        </div>
                    </div>
                </div>

                <!-- L1/L2/L3 Card -->
                <div class="card-hover bg-white dark:bg-dark-card rounded-2xl p-6 border border-gray-200 dark:border-dark-border">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-rose-400 to-pink-500 flex items-center justify-center">
                            <i class="fas fa-wave-square text-white"></i>
                        </div>
                        <h4 class="font-semibold text-lg">L1/L2/L3 频段</h4>
                    </div>
                    <p class="text-gray-600 dark:text-gray-400 text-sm leading-relaxed mb-4">
                        卫星发射信号的不同"频道"，每个频段有不同特性：
                    </p>
                    <div class="space-y-2 text-sm">
                        <div class="flex items-center justify-between bg-gray-50 dark:bg-gray-800/50 rounded-lg px-3 py-2">
                            <span class="font-medium">L1</span>
                            <span class="text-gray-500 dark:text-gray-400">1575.42 MHz · 民用主频</span>
                        </div>
                        <div class="flex items-center justify-between bg-gray-50 dark:bg-gray-800/50 rounded-lg px-3 py-2">
                            <span class="font-medium">L2</span>
                            <span class="text-gray-500 dark:text-gray-400">1227.60 MHz · 抗干扰强</span>
                        </div>
                        <div class="flex items-center justify-between bg-gray-50 dark:bg-gray-800/50 rounded-lg px-3 py-2">
                            <span class="font-medium">L3/L5</span>
                            <span class="text-gray-500 dark:text-gray-400">1176.45 MHz · 高精度</span>
                        </div>
                    </div>
                </div>

                <!-- SNR Card -->
                <div class="card-hover bg-white dark:bg-dark-card rounded-2xl p-6 border border-gray-200 dark:border-dark-border">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-cyan-400 to-blue-500 flex items-center justify-center">
                            <i class="fas fa-signal text-white"></i>
                        </div>
                        <h4 class="font-semibold text-lg">信噪比 (SNR)</h4>
                    </div>
                    <p class="text-gray-600 dark:text-gray-400 text-sm leading-relaxed mb-4">
                        信号强度的衡量指标，单位是 <strong>dB-Hz</strong>。数值越大，信号越清晰稳定。
                    </p>
                    <div class="space-y-2">
                        <div class="flex items-center gap-2">
                            <div class="flex-1 h-2 rounded-full bg-gradient-to-r from-red-400 via-yellow-400 to-green-400"></div>
                        </div>
                        <div class="flex justify-between text-xs text-gray-500 dark:text-gray-400">
                            <span>< 30 dB-Hz<br/>弱信号</span>
                            <span class="text-center">30-40 dB-Hz<br/>一般</span>
                            <span class="text-right">> 40 dB-Hz<br/>良好</span>
                        </div>
                    </div>
                </div>

                <!-- 多路径效应 Card -->
                <div class="card-hover bg-white dark:bg-dark-card rounded-2xl p-6 border border-gray-200 dark:border-dark-border">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-slate-400 to-gray-600 flex items-center justify-center">
                            <i class="fas fa-building text-white"></i>
                        </div>
                        <h4 class="font-semibold text-lg">多路径效应</h4>
                    </div>
                    <p class="text-gray-600 dark:text-gray-400 text-sm leading-relaxed">
                        卫星信号被建筑物、地面等反射后到达接收器，造成定位误差。
                    </p>
                    <div class="mt-4 bg-slate-50 dark:bg-slate-800/50 rounded-xl p-4 text-sm">
                        <p class="text-gray-700 dark:text-gray-300">
                            <i class="fas fa-exclamation-triangle text-amber-500 mr-2"></i>
                            <strong>低仰角卫星</strong>（< 15°）更容易受多路径影响，通常会被设备过滤。
                        </p>
                    </div>
                </div>
            </div>
        </section>

        <!-- File Upload Section -->
        <section class="mb-8 opacity-0 animate-fade-in-up animate-delay-100">
            <div class="bg-white dark:bg-dark-card rounded-2xl p-6 border border-gray-200 dark:border-dark-border">
                <!-- Mode Toggle -->
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-lg bg-violet-100 dark:bg-violet-900/30 flex items-center justify-center">
                            <i class="fas fa-upload text-violet-600 dark:text-violet-400"></i>
                        </div>
                        <h3 class="text-lg font-semibold">数据上传</h3>
                    </div>
                    <div class="mode-toggle flex items-center">
                        <div class="mode-toggle-indicator" id="modeIndicator" style="left: 4px; width: 80px;"></div>
                        <button class="mode-toggle-btn active" id="singleModeBtn" onclick="switchMode('single')">单文件</button>
                        <button class="mode-toggle-btn" id="dualModeBtn" onclick="switchMode('dual')">对比模式</button>
                    </div>
                </div>

                <!-- Single File Mode -->
                <div id="singleModeUpload">
                    <div class="upload-zone rounded-xl p-8 text-center cursor-pointer" id="uploadZone" onclick="document.getElementById('fileInput').click()">
                        <input type="file" id="fileInput" accept=".bin" class="hidden" onchange="handleFileSelect(event)">
                        <div id="uploadPlaceholder">
                            <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-gray-100 dark:bg-gray-800 flex items-center justify-center">
                                <i class="fas fa-cloud-upload-alt text-3xl text-gray-400"></i>
                            </div>
                            <p class="text-gray-600 dark:text-gray-400 mb-2">拖拽 .bin 文件到此处，或点击选择文件</p>
                            <p class="text-sm text-gray-400 dark:text-gray-500">支持标准 RTCM3 格式的二进制数据文件</p>
                        </div>
                        <div id="uploadProgress" class="hidden">
                            <div class="flex items-center justify-center gap-3 mb-4">
                                <i class="fas fa-spinner animate-spin text-2xl text-indigo-500"></i>
                                <span class="text-gray-700 dark:text-gray-300" id="progressText">解析中...</span>
                            </div>
                            <div class="w-full max-w-md mx-auto bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                                <div class="bg-indigo-500 h-2 rounded-full transition-all duration-300" id="progressBar" style="width: 0%"></div>
                            </div>
                        </div>
                        <div id="uploadSuccess" class="hidden">
                            <div class="flex items-center justify-center gap-3">
                                <i class="fas fa-check-circle text-2xl text-emerald-500"></i>
                                <div class="text-left">
                                    <p class="font-medium text-gray-700 dark:text-gray-300" id="fileName"></p>
                                    <p class="text-sm text-gray-500" id="fileInfo"></p>
                                </div>
                                <button class="ml-4 px-3 py-1 text-sm bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-lg" onclick="event.stopPropagation(); clearUpload()">
                                    <i class="fas fa-times mr-1"></i>清除
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Dual File Mode -->
                <div id="dualModeUpload" class="hidden">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Base Station -->
                        <div class="upload-zone rounded-xl p-6 text-center cursor-pointer" id="baseUploadZone" onclick="document.getElementById('baseFileInput').click()">
                            <input type="file" id="baseFileInput" accept=".bin" class="hidden" onchange="handleBaseFileSelect(event)">
                            <div id="basePlaceholder">
                                <div class="w-12 h-12 mx-auto mb-3 rounded-full bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center">
                                    <i class="fas fa-broadcast-tower text-xl text-blue-500"></i>
                                </div>
                                <p class="font-medium text-gray-700 dark:text-gray-300 mb-1">基站数据</p>
                                <p class="text-sm text-gray-400">点击或拖拽上传</p>
                            </div>
                            <div id="baseSuccess" class="hidden">
                                <div class="flex items-center justify-center gap-2">
                                    <i class="fas fa-check-circle text-emerald-500"></i>
                                    <span class="text-sm font-medium text-gray-700 dark:text-gray-300" id="baseFileName"></span>
                                </div>
                            </div>
                        </div>
                        <!-- Rover Station -->
                        <div class="upload-zone rounded-xl p-6 text-center cursor-pointer" id="roverUploadZone" onclick="document.getElementById('roverFileInput').click()">
                            <input type="file" id="roverFileInput" accept=".bin" class="hidden" onchange="handleRoverFileSelect(event)">
                            <div id="roverPlaceholder">
                                <div class="w-12 h-12 mx-auto mb-3 rounded-full bg-emerald-100 dark:bg-emerald-900/30 flex items-center justify-center">
                                    <i class="fas fa-location-dot text-xl text-emerald-500"></i>
                                </div>
                                <p class="font-medium text-gray-700 dark:text-gray-300 mb-1">测站数据</p>
                                <p class="text-sm text-gray-400">点击或拖拽上传</p>
                            </div>
                            <div id="roverSuccess" class="hidden">
                                <div class="flex items-center justify-center gap-2">
                                    <i class="fas fa-check-circle text-emerald-500"></i>
                                    <span class="text-sm font-medium text-gray-700 dark:text-gray-300" id="roverFileName"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="dualProgress" class="hidden mt-4">
                        <div class="flex items-center justify-center gap-3">
                            <i class="fas fa-spinner animate-spin text-indigo-500"></i>
                            <span class="text-gray-600 dark:text-gray-400" id="dualProgressText">解析中...</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Timeline Player Section -->
        <section id="timelineSection" class="mb-8 hidden">
            <div class="bg-white dark:bg-dark-card rounded-2xl p-6 border border-gray-200 dark:border-dark-border">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-lg bg-cyan-100 dark:bg-cyan-900/30 flex items-center justify-center">
                            <i class="fas fa-clock text-cyan-600 dark:text-cyan-400"></i>
                        </div>
                        <h3 class="text-lg font-semibold">时间轴播放</h3>
                    </div>
                    <div class="flex items-center gap-2 text-sm">
                        <span class="text-gray-500 dark:text-gray-400">历元:</span>
                        <span class="font-mono font-medium" id="currentEpoch">0</span>
                        <span class="text-gray-400">/</span>
                        <span class="font-mono text-gray-500" id="totalEpochs">0</span>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <div class="flex items-center gap-2">
                        <button class="p-2 rounded-lg bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors" onclick="skipBackward()" title="后退10帧">
                            <i class="fas fa-backward"></i>
                        </button>
                        <button class="p-3 rounded-xl bg-indigo-500 hover:bg-indigo-600 text-white transition-colors" id="playPauseBtn" onclick="togglePlayPause()">
                            <i class="fas fa-play" id="playIcon"></i>
                        </button>
                        <button class="p-2 rounded-lg bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors" onclick="skipForward()" title="前进10帧">
                            <i class="fas fa-forward"></i>
                        </button>
                    </div>
                    <div class="flex-1">
                        <input type="range" class="timeline-slider" id="timelineSlider" min="0" max="100" value="0" oninput="seekTimeline(this.value)">
                    </div>
                    <div class="flex items-center gap-2">
                        <label class="text-sm text-gray-500 dark:text-gray-400">速度:</label>
                        <select class="px-2 py-1 text-sm bg-gray-100 dark:bg-gray-700 rounded-lg border-0" id="playbackSpeed" onchange="changePlaybackSpeed(this.value)">
                            <option value="0.5">0.5x</option>
                            <option value="1" selected>1x</option>
                            <option value="2">2x</option>
                            <option value="5">5x</option>
                            <option value="10">10x</option>
                        </select>
                    </div>
                </div>
                <div class="mt-3 text-center">
                    <span class="text-sm text-gray-500 dark:text-gray-400">时间戳: </span>
                    <span class="font-mono text-sm" id="currentTimestamp">--:--:--</span>
                </div>
            </div>
        </section>

        <!-- Skyplot Section - Single Mode -->
        <section id="singleSkyplotSection" class="mb-8 hidden">
            <div class="flex items-center gap-2 mb-6">
                <div class="w-8 h-8 rounded-lg bg-emerald-100 dark:bg-emerald-900/30 flex items-center justify-center">
                    <i class="fas fa-chart-pie text-emerald-600 dark:text-emerald-400"></i>
                </div>
                <h3 class="text-xl font-semibold">卫星信号分析</h3>
                <span class="text-sm text-gray-500 dark:text-gray-400">(简化视图 - 无仰角/方位角数据)</span>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Skyplot Canvas -->
                <div class="bg-white dark:bg-dark-card rounded-2xl p-6 border border-gray-200 dark:border-dark-border">
                    <div class="flex items-center justify-between mb-4">
                        <h4 class="font-medium text-gray-700 dark:text-gray-300">卫星分布图</h4>
                        <div class="flex items-center gap-2">
                            <span class="text-sm text-gray-500">卫星总数:</span>
                            <span class="font-bold text-indigo-500" id="totalSatCount">0</span>
                        </div>
                    </div>
                    <div class="relative aspect-square max-w-md mx-auto">
                        <canvas id="skyplotCanvas" class="w-full h-full"></canvas>
                    </div>
                    <!-- Legend -->
                    <div class="flex flex-wrap justify-center gap-4 mt-6 text-sm">
                        <div class="flex items-center gap-2">
                            <span class="w-4 h-4 rounded-full bg-gps"></span>
                            <span>GPS</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="w-4 h-4 rounded-full bg-beidou"></span>
                            <span>北斗</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="w-4 h-4 rounded-full bg-glonass"></span>
                            <span>GLONASS</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="w-4 h-4 rounded-full bg-galileo"></span>
                            <span>Galileo</span>
                        </div>
                    </div>
                </div>

                <!-- Signal Strength Chart -->
                <div class="bg-white dark:bg-dark-card rounded-2xl p-6 border border-gray-200 dark:border-dark-border">
                    <h4 class="font-medium text-gray-700 dark:text-gray-300 mb-4">信号强度分布</h4>
                    <div id="signalBars" class="space-y-2 max-h-[360px] overflow-y-auto pr-2">
                        <div class="text-center text-gray-400 py-8">
                            <i class="fas fa-satellite-dish text-4xl mb-2 opacity-50"></i>
                            <p>请上传 RTCM3 数据文件</p>
                        </div>
                    </div>
                    <div class="mt-4 pt-4 border-t border-gray-200 dark:border-dark-border">
                        <div class="grid grid-cols-3 gap-4 text-center text-sm">
                            <div>
                                <p class="text-2xl font-bold text-emerald-500" id="goodSignalCount">0</p>
                                <p class="text-gray-500 dark:text-gray-400">&gt;40 dB</p>
                            </div>
                            <div>
                                <p class="text-2xl font-bold text-amber-500" id="mediumSignalCount">0</p>
                                <p class="text-gray-500 dark:text-gray-400">30-40 dB</p>
                            </div>
                            <div>
                                <p class="text-2xl font-bold text-red-500" id="weakSignalCount">0</p>
                                <p class="text-gray-500 dark:text-gray-400">&lt;30 dB</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Skyplot Section - Dual Mode (Comparison) -->
        <section id="dualSkyplotSection" class="mb-8 hidden">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 rounded-lg bg-violet-100 dark:bg-violet-900/30 flex items-center justify-center">
                        <i class="fas fa-code-compare text-violet-600 dark:text-violet-400"></i>
                    </div>
                    <h3 class="text-xl font-semibold">基站 vs 测站 对比分析</h3>
                </div>
                <div class="flex items-center gap-2">
                    <span class="w-3 h-3 rounded-full bg-emerald-500 ring-2 ring-emerald-300"></span>
                    <span class="text-sm text-gray-600 dark:text-gray-400">共视卫星</span>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Base Station Skyplot -->
                <div class="bg-white dark:bg-dark-card rounded-2xl p-6 border border-gray-200 dark:border-dark-border">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-2">
                            <i class="fas fa-broadcast-tower text-blue-500"></i>
                            <h4 class="font-medium text-gray-700 dark:text-gray-300">基站</h4>
                        </div>
                        <span class="text-sm"><span class="font-bold text-blue-500" id="baseSatCount">0</span> 颗卫星</span>
                    </div>
                    <div class="relative aspect-square max-w-sm mx-auto">
                        <canvas id="baseSkyplotCanvas" class="w-full h-full"></canvas>
                    </div>
                </div>

                <!-- Rover Station Skyplot -->
                <div class="bg-white dark:bg-dark-card rounded-2xl p-6 border border-gray-200 dark:border-dark-border">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-2">
                            <i class="fas fa-location-dot text-emerald-500"></i>
                            <h4 class="font-medium text-gray-700 dark:text-gray-300">测站</h4>
                        </div>
                        <span class="text-sm"><span class="font-bold text-emerald-500" id="roverSatCount">0</span> 颗卫星</span>
                    </div>
                    <div class="relative aspect-square max-w-sm mx-auto">
                        <canvas id="roverSkyplotCanvas" class="w-full h-full"></canvas>
                    </div>
                </div>
            </div>

            <!-- Comparison Stats -->
            <div class="mt-6 bg-white dark:bg-dark-card rounded-2xl p-6 border border-gray-200 dark:border-dark-border">
                <h4 class="font-medium text-gray-700 dark:text-gray-300 mb-4">共视卫星统计</h4>
                <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                    <div class="text-center p-4 bg-gray-50 dark:bg-gray-800/50 rounded-xl">
                        <p class="text-3xl font-bold text-emerald-500" id="commonSatCount">0</p>
                        <p class="text-sm text-gray-500">共视卫星</p>
                    </div>
                    <div class="text-center p-4 bg-gray-50 dark:bg-gray-800/50 rounded-xl">
                        <p class="text-3xl font-bold text-gps" id="commonGpsCount">0</p>
                        <p class="text-sm text-gray-500">GPS</p>
                    </div>
                    <div class="text-center p-4 bg-gray-50 dark:bg-gray-800/50 rounded-xl">
                        <p class="text-3xl font-bold text-beidou" id="commonBeidouCount">0</p>
                        <p class="text-sm text-gray-500">北斗</p>
                    </div>
                    <div class="text-center p-4 bg-gray-50 dark:bg-gray-800/50 rounded-xl">
                        <p class="text-3xl font-bold text-glonass" id="commonGlonassCount">0</p>
                        <p class="text-sm text-gray-500">GLONASS</p>
                    </div>
                    <div class="text-center p-4 bg-gray-50 dark:bg-gray-800/50 rounded-xl">
                        <p class="text-3xl font-bold text-galileo" id="commonGalileoCount">0</p>
                        <p class="text-sm text-gray-500">Galileo</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Analysis Results Section -->
        <section id="analysisSection" class="mb-8 hidden">
            <div class="flex items-center gap-2 mb-6">
                <div class="w-8 h-8 rounded-lg bg-rose-100 dark:bg-rose-900/30 flex items-center justify-center">
                    <i class="fas fa-stethoscope text-rose-600 dark:text-rose-400"></i>
                </div>
                <h3 class="text-xl font-semibold">自动诊断分析</h3>
            </div>

            <div id="analysisCards" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <!-- Dynamic analysis cards will be inserted here -->
            </div>

            <!-- Signal Trend Chart -->
            <div class="bg-white dark:bg-dark-card rounded-2xl p-6 border border-gray-200 dark:border-dark-border">
                <h4 class="font-medium text-gray-700 dark:text-gray-300 mb-4">信号强度趋势</h4>
                <div class="relative h-64">
                    <canvas id="trendChart" class="w-full h-full"></canvas>
                </div>
                <div class="flex flex-wrap justify-center gap-4 mt-4 text-sm" id="trendLegend">
                    <!-- Dynamic legend -->
                </div>
            </div>
        </section>

        <!-- Data Table Section -->
        <section id="dataTableSection" class="mb-8 hidden">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 rounded-lg bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center">
                        <i class="fas fa-table text-blue-600 dark:text-blue-400"></i>
                    </div>
                    <h3 class="text-xl font-semibold">卫星观测数据</h3>
                </div>
                <div class="flex items-center gap-2">
                    <label class="text-sm text-gray-500">筛选系统:</label>
                    <select class="px-3 py-1.5 text-sm bg-gray-100 dark:bg-gray-700 rounded-lg border-0" id="systemFilter" onchange="filterTable()">
                        <option value="all">全部</option>
                        <option value="GPS">GPS</option>
                        <option value="BDS">北斗</option>
                        <option value="GLO">GLONASS</option>
                        <option value="GAL">Galileo</option>
                    </select>
                </div>
            </div>

            <div class="bg-white dark:bg-dark-card rounded-2xl border border-gray-200 dark:border-dark-border overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="bg-gray-50 dark:bg-gray-800/50 border-b border-gray-200 dark:border-dark-border">
                                <th class="px-4 py-3 text-left font-medium text-gray-600 dark:text-gray-400">卫星</th>
                                <th class="px-4 py-3 text-left font-medium text-gray-600 dark:text-gray-400">系统</th>
                                <th class="px-4 py-3 text-center font-medium text-gray-600 dark:text-gray-400">信号1</th>
                                <th class="px-4 py-3 text-center font-medium text-gray-600 dark:text-gray-400">信号2</th>
                                <th class="px-4 py-3 text-center font-medium text-gray-600 dark:text-gray-400">信号3</th>
                                <th class="px-4 py-3 text-center font-medium text-gray-600 dark:text-gray-400">平均CNR</th>
                                <th class="px-4 py-3 text-center font-medium text-gray-600 dark:text-gray-400">信号质量</th>
                            </tr>
                        </thead>
                        <tbody id="satelliteTableBody">
                            <tr>
                                <td colspan="7" class="px-4 py-12 text-center text-gray-400">
                                    <i class="fas fa-inbox text-4xl mb-2 opacity-50"></i>
                                    <p>暂无数据，请上传 RTCM3 文件</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Problem Analysis Section -->
        <section class="mb-12 opacity-0 animate-fade-in-up animate-delay-400">
            <div class="flex items-center gap-2 mb-6">
                <div class="w-8 h-8 rounded-lg bg-rose-100 dark:bg-rose-900/30 flex items-center justify-center">
                    <i class="fas fa-search-plus text-rose-600 dark:text-rose-400"></i>
                </div>
                <h3 class="text-xl font-semibold">问题分析指南</h3>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Signal Blocking -->
                <div class="card-hover bg-white dark:bg-dark-card rounded-2xl p-6 border border-gray-200 dark:border-dark-border">
                    <div class="flex items-start gap-4">
                        <div class="w-12 h-12 rounded-xl bg-red-100 dark:bg-red-900/30 flex items-center justify-center flex-shrink-0">
                            <i class="fas fa-ban text-red-500 text-xl"></i>
                        </div>
                        <div>
                            <h4 class="font-semibold mb-2">信号遮挡问题</h4>
                            <p class="text-gray-600 dark:text-gray-400 text-sm mb-3">
                                某个方向的卫星完全看不到，星空图上出现明显的"空白区域"。
                            </p>
                            <div class="bg-red-50 dark:bg-red-900/20 rounded-lg p-3 text-sm">
                                <p class="font-medium text-red-700 dark:text-red-300 mb-1">判断方法：</p>
                                <ul class="text-red-600 dark:text-red-400 space-y-1 list-disc list-inside">
                                    <li>星空图某方向持续无卫星</li>
                                    <li>对应方向可能有高大建筑或山体</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Multipath Effect -->
                <div class="card-hover bg-white dark:bg-dark-card rounded-2xl p-6 border border-gray-200 dark:border-dark-border">
                    <div class="flex items-start gap-4">
                        <div class="w-12 h-12 rounded-xl bg-amber-100 dark:bg-amber-900/30 flex items-center justify-center flex-shrink-0">
                            <i class="fas fa-random text-amber-500 text-xl"></i>
                        </div>
                        <div>
                            <h4 class="font-semibold mb-2">多路径效应</h4>
                            <p class="text-gray-600 dark:text-gray-400 text-sm mb-3">
                                低仰角卫星信号异常，或同一颗卫星的信号强度波动剧烈。
                            </p>
                            <div class="bg-amber-50 dark:bg-amber-900/20 rounded-lg p-3 text-sm">
                                <p class="font-medium text-amber-700 dark:text-amber-300 mb-1">判断方法：</p>
                                <ul class="text-amber-600 dark:text-amber-400 space-y-1 list-disc list-inside">
                                    <li>仰角 < 15° 的卫星信号不稳定</li>
                                    <li>周围有大面积反光物体（水面、玻璃幕墙）</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Device Fault -->
                <div class="card-hover bg-white dark:bg-dark-card rounded-2xl p-6 border border-gray-200 dark:border-dark-border">
                    <div class="flex items-start gap-4">
                        <div class="w-12 h-12 rounded-xl bg-purple-100 dark:bg-purple-900/30 flex items-center justify-center flex-shrink-0">
                            <i class="fas fa-exclamation-circle text-purple-500 text-xl"></i>
                        </div>
                        <div>
                            <h4 class="font-semibold mb-2">设备故障</h4>
                            <p class="text-gray-600 dark:text-gray-400 text-sm mb-3">
                                所有卫星信号普遍偏弱，无论仰角高低，信噪比都很低。
                            </p>
                            <div class="bg-purple-50 dark:bg-purple-900/20 rounded-lg p-3 text-sm">
                                <p class="font-medium text-purple-700 dark:text-purple-300 mb-1">判断方法：</p>
                                <ul class="text-purple-600 dark:text-purple-400 space-y-1 list-disc list-inside">
                                    <li>高仰角卫星（> 60°）信号也很弱</li>
                                    <li>多个频段信号同时偏低</li>
                                    <li>检查天线连接和设备状态</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Environmental Interference -->
                <div class="card-hover bg-white dark:bg-dark-card rounded-2xl p-6 border border-gray-200 dark:border-dark-border">
                    <div class="flex items-start gap-4">
                        <div class="w-12 h-12 rounded-xl bg-cyan-100 dark:bg-cyan-900/30 flex items-center justify-center flex-shrink-0">
                            <i class="fas fa-bolt text-cyan-500 text-xl"></i>
                        </div>
                        <div>
                            <h4 class="font-semibold mb-2">环境干扰</h4>
                            <p class="text-gray-600 dark:text-gray-400 text-sm mb-3">
                                信号强度大幅波动，时好时坏，没有规律可循。
                            </p>
                            <div class="bg-cyan-50 dark:bg-cyan-900/20 rounded-lg p-3 text-sm">
                                <p class="font-medium text-cyan-700 dark:text-cyan-300 mb-1">判断方法：</p>
                                <ul class="text-cyan-600 dark:text-cyan-400 space-y-1 list-disc list-inside">
                                    <li>信号强度短时间内剧烈变化</li>
                                    <li>附近可能有电磁干扰源</li>
                                    <li>尝试更换设备位置测试</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Diagnosis Tips -->
            <div class="mt-6 bg-gradient-to-r from-indigo-500 to-purple-600 rounded-2xl p-6 text-white">
                <div class="flex items-start gap-4">
                    <div class="w-12 h-12 rounded-xl bg-white/20 flex items-center justify-center flex-shrink-0">
                        <i class="fas fa-lightbulb text-2xl"></i>
                    </div>
                    <div>
                        <h4 class="font-semibold text-lg mb-2">快速诊断小技巧</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-white/90">
                            <div class="flex items-start gap-2">
                                <i class="fas fa-check-circle mt-0.5"></i>
                                <span>理想状态下，应能看到 8-12 颗以上卫星</span>
                            </div>
                            <div class="flex items-start gap-2">
                                <i class="fas fa-check-circle mt-0.5"></i>
                                <span>高仰角卫星（> 45°）信号应 > 40 dB-Hz</span>
                            </div>
                            <div class="flex items-start gap-2">
                                <i class="fas fa-check-circle mt-0.5"></i>
                                <span>卫星分布应尽量均匀，避免集中在一侧</span>
                            </div>
                            <div class="flex items-start gap-2">
                                <i class="fas fa-check-circle mt-0.5"></i>
                                <span>RTK固定解需要至少 5 颗共视卫星</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="border-t border-gray-200 dark:border-dark-border bg-white dark:bg-dark-card mt-12">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="flex flex-col md:flex-row items-center justify-between gap-4">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center">
                        <i class="fas fa-satellite text-white text-sm"></i>
                    </div>
                    <span class="font-medium">GNSS卫星星空图</span>
                </div>
                <div class="flex items-center gap-4 text-sm text-gray-500 dark:text-gray-400">
                    <span>作者: 伐木</span>
                    <a href="http://t.cn/A6BbJgnN" target="_blank" class="hover:text-indigo-500 transition-colors">
                        <i class="fab fa-twitter mr-1"></i>Twitter/X
                    </a>
                </div>
                <p class="text-sm text-gray-400 dark:text-gray-500">
                    © 2025 All Rights Reserved
                </p>
            </div>
        </div>
    </footer>

    <script>
        // ============================================
        // Global State
        // ============================================
        const state = {
            mode: 'single', // 'single' or 'dual'
            singleData: null,
            baseData: null,
            roverData: null,
            currentEpochIndex: 0,
            isPlaying: false,
            playbackSpeed: 1,
            animationFrameId: null,
            lastFrameTime: 0
        };

        const systemColors = {
            'GPS': '#22c55e',
            'BDS': '#ef4444',
            'GLO': '#3b82f6',
            'GAL': '#f97316'
        };

        const systemNames = {
            'GPS': 'GPS',
            'BDS': '北斗',
            'GLO': 'GLONASS',
            'GAL': 'Galileo'
        };

        // ============================================
        // RTCM3 Parser
        // ============================================
        class RTCM3Parser {
            constructor() {
                this.CRC24Q_TABLE = this.generateCRC24QTable();
            }

            generateCRC24QTable() {
                const table = new Uint32Array(256);
                const poly = 0x1864CFB;
                for (let i = 0; i < 256; i++) {
                    let crc = i << 16;
                    for (let j = 0; j < 8; j++) {
                        crc = (crc << 1) ^ ((crc & 0x800000) ? poly : 0);
                    }
                    table[i] = crc & 0xFFFFFF;
                }
                return table;
            }

            crc24q(data, length) {
                let crc = 0;
                for (let i = 0; i < length; i++) {
                    crc = ((crc << 8) ^ this.CRC24Q_TABLE[(crc >> 16) ^ data[i]]) & 0xFFFFFF;
                }
                return crc;
            }

            parse(buffer, progressCallback) {
                const data = new Uint8Array(buffer);
                const epochs = [];
                let i = 0;
                const totalLength = data.length;
                let lastProgress = 0;

                while (i < data.length - 6) {
                    // Report progress
                    const progress = Math.floor((i / totalLength) * 100);
                    if (progress !== lastProgress && progressCallback) {
                        progressCallback(progress);
                        lastProgress = progress;
                    }

                    // Find frame header 0xD3
                    if (data[i] !== 0xD3) {
                        i++;
                        continue;
                    }

                    // Check reserved bits (should be 0)
                    if ((data[i + 1] & 0xFC) !== 0) {
                        i++;
                        continue;
                    }

                    // Get message length
                    const length = ((data[i + 1] & 0x03) << 8) | data[i + 2];
                    if (length > 1023 || i + 3 + length + 3 > data.length) {
                        i++;
                        continue;
                    }

                    // Verify CRC
                    const frameLength = 3 + length;
                    const calculatedCRC = this.crc24q(data.slice(i, i + frameLength), frameLength);
                    const receivedCRC = (data[i + frameLength] << 16) | (data[i + frameLength + 1] << 8) | data[i + frameLength + 2];

                    if (calculatedCRC !== receivedCRC) {
                        i++;
                        continue;
                    }

                    // Parse message
                    const messageData = data.slice(i + 3, i + 3 + length);
                    const messageType = (messageData[0] << 4) | (messageData[1] >> 4);
                    
                    const parsed = this.parseMessage(messageType, messageData);
                    if (parsed) {
                        epochs.push(parsed);
                    }

                    i += 3 + length + 3;
                }

                if (progressCallback) progressCallback(100);
                return this.mergeEpochs(epochs);
            }

            parseMessage(type, data) {
                // MSM4 messages (recommended for basic observation data)
                // GPS: 1074, GLONASS: 1084, Galileo: 1094, BeiDou: 1124
                // MSM5 messages
                // GPS: 1075, GLONASS: 1085, Galileo: 1095, BeiDou: 1125
                // MSM6 messages
                // GPS: 1076, GLONASS: 1086, Galileo: 1096, BeiDou: 1126
                // MSM7 messages (full observation data)
                // GPS: 1077, GLONASS: 1087, Galileo: 1097, BeiDou: 1127

                let system = null;
                let msmType = 0;

                if (type >= 1074 && type <= 1077) {
                    system = 'GPS';
                    msmType = type - 1070;
                } else if (type >= 1084 && type <= 1087) {
                    system = 'GLO';
                    msmType = type - 1080;
                } else if (type >= 1094 && type <= 1097) {
                    system = 'GAL';
                    msmType = type - 1090;
                } else if (type >= 1124 && type <= 1127) {
                    system = 'BDS';
                    msmType = type - 1120;
                }

                if (system && msmType >= 4) {
                    return this.parseMSM(data, system, msmType);
                }

                return null;
            }

            parseMSM(data, system, msmType) {
                const view = new DataView(data.buffer, data.byteOffset, data.byteLength);
                let bitPos = 12; // Skip message type (12 bits)

                // Reference station ID (12 bits)
                const stationId = this.getBits(data, bitPos, 12);
                bitPos += 12;

                // GNSS Epoch Time (30 bits for GPS, different for others)
                const epochTime = this.getBits(data, bitPos, 30);
                bitPos += 30;

                // Multiple Message bit (1 bit)
                bitPos += 1;

                // IODS (3 bits)
                bitPos += 3;

                // Reserved (7 bits)
                bitPos += 7;

                // Clock Steering Indicator (2 bits)
                bitPos += 2;

                // External Clock Indicator (2 bits)
                bitPos += 2;

                // GNSS Divergence-free Smoothing Indicator (1 bit)
                bitPos += 1;

                // GNSS Smoothing Interval (3 bits)
                bitPos += 3;

                // Satellite mask (64 bits)
                const satMaskHigh = this.getBits(data, bitPos, 32);
                bitPos += 32;
                const satMaskLow = this.getBits(data, bitPos, 32);
                bitPos += 32;

                // Count satellites
                const satellites = [];
                for (let prn = 1; prn <= 64; prn++) {
                    const bit = prn <= 32 ? (satMaskHigh >> (32 - prn)) & 1 : (satMaskLow >> (64 - prn)) & 1;
                    if (bit) {
                        satellites.push(prn);
                    }
                }

                if (satellites.length === 0) return null;

                // Signal mask (32 bits)
                const signalMask = this.getBits(data, bitPos, 32);
                bitPos += 32;

                // Count signals
                const signals = [];
                for (let sig = 1; sig <= 32; sig++) {
                    if ((signalMask >> (32 - sig)) & 1) {
                        signals.push(sig);
                    }
                }

                if (signals.length === 0) return null;

                // Cell mask
                const numCells = satellites.length * signals.length;
                const cellMask = [];
                for (let i = 0; i < numCells; i++) {
                    cellMask.push(this.getBit(data, bitPos + i));
                }
                bitPos += numCells;

                // Count active cells
                const numActiveCells = cellMask.filter(c => c).length;

                // Skip satellite data for MSM4-7
                // Satellite rough ranges (for all satellites)
                bitPos += satellites.length * 8; // Rough ranges integer ms
                
                if (msmType >= 5) {
                    bitPos += satellites.length * 4; // Extended info
                }
                
                bitPos += satellites.length * 10; // Rough ranges modulo 1ms
                
                if (msmType >= 5) {
                    bitPos += satellites.length * 14; // Phase range rates
                }

                // Signal data - CNR values
                const cnrValues = [];
                
                // Skip pseudorange fine
                bitPos += numActiveCells * 15;
                
                // Skip phase range fine
                bitPos += numActiveCells * 22;
                
                // Skip phase range lock time
                bitPos += numActiveCells * 4;
                
                // Skip half cycle ambiguity
                bitPos += numActiveCells;
                
                // Read CNR values (6 bits each for MSM4/5, 10 bits for MSM6/7)
                const cnrBits = (msmType >= 6) ? 10 : 6;
                const cnrScale = (msmType >= 6) ? 0.0625 : 1;
                
                for (let i = 0; i < numActiveCells; i++) {
                    const cnr = this.getBits(data, bitPos, cnrBits) * cnrScale;
                    cnrValues.push(cnr);
                    bitPos += cnrBits;
                }

                // Build satellite observations
                const observations = [];
                let cellIdx = 0;
                let cnrIdx = 0;

                for (let satIdx = 0; satIdx < satellites.length; satIdx++) {
                    const prn = satellites[satIdx];
                    const satSignals = [];

                    for (let sigIdx = 0; sigIdx < signals.length; sigIdx++) {
                        if (cellMask[cellIdx]) {
                            satSignals.push({
                                signalId: signals[sigIdx],
                                cnr: cnrValues[cnrIdx] || 0
                            });
                            cnrIdx++;
                        }
                        cellIdx++;
                    }

                    if (satSignals.length > 0) {
                        observations.push({
                            prn: prn,
                            system: system,
                            signals: satSignals
                        });
                    }
                }

                return {
                    type: 'MSM' + msmType,
                    system: system,
                    stationId: stationId,
                    epochTime: epochTime,
                    observations: observations
                };
            }

            getBits(data, bitPos, numBits) {
                let value = 0;
                for (let i = 0; i < numBits; i++) {
                    value = (value << 1) | this.getBit(data, bitPos + i);
                }
                return value;
            }

            getBit(data, bitPos) {
                const bytePos = Math.floor(bitPos / 8);
                const bitOffset = 7 - (bitPos % 8);
                if (bytePos >= data.length) return 0;
                return (data[bytePos] >> bitOffset) & 1;
            }

            mergeEpochs(rawEpochs) {
                // Group by epoch time
                const epochMap = new Map();
                
                for (const epoch of rawEpochs) {
                    const key = epoch.epochTime;
                    if (!epochMap.has(key)) {
                        epochMap.set(key, {
                            epochTime: epoch.epochTime,
                            stationId: epoch.stationId,
                            satellites: new Map()
                        });
                    }
                    
                    const merged = epochMap.get(key);
                    for (const obs of epoch.observations) {
                        const satKey = `${obs.system}${obs.prn}`;
                        if (!merged.satellites.has(satKey)) {
                            merged.satellites.set(satKey, {
                                prn: obs.prn,
                                system: obs.system,
                                signals: []
                            });
                        }
                        merged.satellites.get(satKey).signals.push(...obs.signals);
                    }
                }

                // Convert to array and sort by time
                const epochs = Array.from(epochMap.values()).sort((a, b) => a.epochTime - b.epochTime);
                
                // Convert satellite maps to arrays
                for (const epoch of epochs) {
                    epoch.satellites = Array.from(epoch.satellites.values());
                    // Sort satellites by system and PRN
                    epoch.satellites.sort((a, b) => {
                        if (a.system !== b.system) {
                            const order = ['GPS', 'BDS', 'GLO', 'GAL'];
                            return order.indexOf(a.system) - order.indexOf(b.system);
                        }
                        return a.prn - b.prn;
                    });
                }

                return epochs;
            }
        }

        // ============================================
        // File Upload Handling
        // ============================================
        const parser = new RTCM3Parser();

        function switchMode(mode) {
            state.mode = mode;
            const indicator = document.getElementById('modeIndicator');
            const singleBtn = document.getElementById('singleModeBtn');
            const dualBtn = document.getElementById('dualModeBtn');
            const singleUpload = document.getElementById('singleModeUpload');
            const dualUpload = document.getElementById('dualModeUpload');

            if (mode === 'single') {
                indicator.style.left = '4px';
                indicator.style.width = '80px';
                singleBtn.classList.add('active');
                dualBtn.classList.remove('active');
                singleUpload.classList.remove('hidden');
                dualUpload.classList.add('hidden');
            } else {
                indicator.style.left = '84px';
                indicator.style.width = '96px';
                singleBtn.classList.remove('active');
                dualBtn.classList.add('active');
                singleUpload.classList.add('hidden');
                dualUpload.classList.remove('hidden');
            }

            // Update display
            updateDisplay();
        }

        function setupDragDrop(zoneId, inputId, handler) {
            const zone = document.getElementById(zoneId);
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                zone.addEventListener(eventName, (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                });
            });

            ['dragenter', 'dragover'].forEach(eventName => {
                zone.addEventListener(eventName, () => zone.classList.add('drag-over'));
            });

            ['dragleave', 'drop'].forEach(eventName => {
                zone.addEventListener(eventName, () => zone.classList.remove('drag-over'));
            });

            zone.addEventListener('drop', (e) => {
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handler({ target: { files: files } });
                }
            });
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            showProgress();
            
            const reader = new FileReader();
            reader.onload = (e) => {
                const epochs = parser.parse(e.target.result, updateProgress);
                state.singleData = epochs;
                state.currentEpochIndex = 0;
                
                showSuccess(file.name, file.size, epochs.length);
                updateDisplay();
            };
            reader.readAsArrayBuffer(file);
        }

        function handleBaseFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            document.getElementById('basePlaceholder').classList.add('hidden');
            document.getElementById('baseSuccess').classList.remove('hidden');
            document.getElementById('baseFileName').textContent = file.name;

            const reader = new FileReader();
            reader.onload = (e) => {
                state.baseData = parser.parse(e.target.result, null);
                state.currentEpochIndex = 0;
                checkDualReady();
            };
            reader.readAsArrayBuffer(file);
        }

        function handleRoverFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            document.getElementById('roverPlaceholder').classList.add('hidden');
            document.getElementById('roverSuccess').classList.remove('hidden');
            document.getElementById('roverFileName').textContent = file.name;

            const reader = new FileReader();
            reader.onload = (e) => {
                state.roverData = parser.parse(e.target.result, null);
                state.currentEpochIndex = 0;
                checkDualReady();
            };
            reader.readAsArrayBuffer(file);
        }

        function checkDualReady() {
            if (state.baseData && state.roverData) {
                updateDisplay();
            }
        }

        function showProgress() {
            document.getElementById('uploadPlaceholder').classList.add('hidden');
            document.getElementById('uploadSuccess').classList.add('hidden');
            document.getElementById('uploadProgress').classList.remove('hidden');
        }

        function updateProgress(percent) {
            document.getElementById('progressBar').style.width = percent + '%';
            document.getElementById('progressText').textContent = `解析中... ${percent}%`;
        }

        function showSuccess(name, size, epochCount) {
            document.getElementById('uploadProgress').classList.add('hidden');
            document.getElementById('uploadSuccess').classList.remove('hidden');
            document.getElementById('fileName').textContent = name;
            document.getElementById('fileInfo').textContent = `${formatFileSize(size)} · ${epochCount} 个历元`;
        }

        function clearUpload() {
            state.singleData = null;
            state.currentEpochIndex = 0;
            stopPlayback();
            
            document.getElementById('uploadPlaceholder').classList.remove('hidden');
            document.getElementById('uploadSuccess').classList.add('hidden');
            document.getElementById('uploadProgress').classList.add('hidden');
            document.getElementById('fileInput').value = '';
            
            updateDisplay();
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        // ============================================
        // Timeline Player
        // ============================================
        function togglePlayPause() {
            if (state.isPlaying) {
                stopPlayback();
            } else {
                startPlayback();
            }
        }

        function startPlayback() {
            state.isPlaying = true;
            document.getElementById('playIcon').classList.remove('fa-play');
            document.getElementById('playIcon').classList.add('fa-pause');
            state.lastFrameTime = performance.now();
            playFrame();
        }

        function stopPlayback() {
            state.isPlaying = false;
            document.getElementById('playIcon').classList.remove('fa-pause');
            document.getElementById('playIcon').classList.add('fa-play');
            if (state.animationFrameId) {
                cancelAnimationFrame(state.animationFrameId);
            }
        }

        function playFrame() {
            if (!state.isPlaying) return;

            const now = performance.now();
            const delta = now - state.lastFrameTime;
            const frameInterval = 1000 / state.playbackSpeed;

            if (delta >= frameInterval) {
                state.lastFrameTime = now;
                
                const epochs = getCurrentEpochs();
                if (state.currentEpochIndex < epochs.length - 1) {
                    state.currentEpochIndex++;
                    updateTimelineUI();
                    renderCurrentEpoch();
                } else {
                    stopPlayback();
                }
            }

            state.animationFrameId = requestAnimationFrame(playFrame);
        }

        function getCurrentEpochs() {
            if (state.mode === 'single') {
                return state.singleData || [];
            } else {
                // Use the shorter of the two datasets
                const baseLen = state.baseData ? state.baseData.length : 0;
                const roverLen = state.roverData ? state.roverData.length : 0;
                return { length: Math.min(baseLen, roverLen) || 0 };
            }
        }

        function seekTimeline(value) {
            const epochs = getCurrentEpochs();
            const maxIndex = (Array.isArray(epochs) ? epochs.length : epochs.length) - 1;
            state.currentEpochIndex = Math.round((value / 100) * maxIndex);
            updateTimelineUI();
            renderCurrentEpoch();
        }

        function skipForward() {
            const epochs = getCurrentEpochs();
            const maxIndex = (Array.isArray(epochs) ? epochs.length : epochs.length) - 1;
            state.currentEpochIndex = Math.min(state.currentEpochIndex + 10, maxIndex);
            updateTimelineUI();
            renderCurrentEpoch();
        }

        function skipBackward() {
            state.currentEpochIndex = Math.max(state.currentEpochIndex - 10, 0);
            updateTimelineUI();
            renderCurrentEpoch();
        }

        function changePlaybackSpeed(speed) {
            state.playbackSpeed = parseFloat(speed);
        }

        function updateTimelineUI() {
            const epochs = getCurrentEpochs();
            const total = Array.isArray(epochs) ? epochs.length : epochs.length;
            
            document.getElementById('currentEpoch').textContent = state.currentEpochIndex + 1;
            document.getElementById('totalEpochs').textContent = total;
            
            const progress = total > 1 ? (state.currentEpochIndex / (total - 1)) * 100 : 0;
            const slider = document.getElementById('timelineSlider');
            slider.value = progress;
            slider.style.background = `linear-gradient(to right, #6366f1 ${progress}%, ${document.documentElement.classList.contains('dark') ? '#374151' : '#d1d5db'} ${progress}%)`;

            // Update timestamp
            if (Array.isArray(epochs) && epochs[state.currentEpochIndex]) {
                const epochTime = epochs[state.currentEpochIndex].epochTime;
                const seconds = Math.floor(epochTime / 1000) % 86400;
                const h = Math.floor(seconds / 3600);
                const m = Math.floor((seconds % 3600) / 60);
                const s = seconds % 60;
                document.getElementById('currentTimestamp').textContent = 
                    `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
            }
        }

        // ============================================
        // Display & Rendering
        // ============================================
        function updateDisplay() {
            const hasData = state.mode === 'single' 
                ? state.singleData && state.singleData.length > 0
                : state.baseData && state.roverData;

            // Show/hide sections
            document.getElementById('timelineSection').classList.toggle('hidden', !hasData);
            document.getElementById('singleSkyplotSection').classList.toggle('hidden', state.mode !== 'single' || !hasData);
            document.getElementById('dualSkyplotSection').classList.toggle('hidden', state.mode !== 'dual' || !hasData);
            document.getElementById('analysisSection').classList.toggle('hidden', !hasData);
            document.getElementById('dataTableSection').classList.toggle('hidden', !hasData);

            if (hasData) {
                updateTimelineUI();
                renderCurrentEpoch();
                runAnalysis();
            }
        }

        function renderCurrentEpoch() {
            if (state.mode === 'single') {
                renderSingleMode();
            } else {
                renderDualMode();
            }
        }

        function renderSingleMode() {
            if (!state.singleData || state.singleData.length === 0) return;
            
            const epoch = state.singleData[state.currentEpochIndex];
            if (!epoch) return;

            drawSimplifiedSkyplot('skyplotCanvas', epoch.satellites);
            renderSignalBars(epoch.satellites);
            renderTable(epoch.satellites);
            
            document.getElementById('totalSatCount').textContent = epoch.satellites.length;
        }

        function renderDualMode() {
            if (!state.baseData || !state.roverData) return;

            const baseEpoch = state.baseData[state.currentEpochIndex];
            const roverEpoch = state.roverData[state.currentEpochIndex];
            
            if (!baseEpoch || !roverEpoch) return;

            // Find common satellites
            const baseSatIds = new Set(baseEpoch.satellites.map(s => `${s.system}${s.prn}`));
            const roverSatIds = new Set(roverEpoch.satellites.map(s => `${s.system}${s.prn}`));
            const commonSatIds = new Set([...baseSatIds].filter(x => roverSatIds.has(x)));

            drawSimplifiedSkyplot('baseSkyplotCanvas', baseEpoch.satellites, commonSatIds);
            drawSimplifiedSkyplot('roverSkyplotCanvas', roverEpoch.satellites, commonSatIds);
            
            document.getElementById('baseSatCount').textContent = baseEpoch.satellites.length;
            document.getElementById('roverSatCount').textContent = roverEpoch.satellites.length;
            
            // Update common satellite counts
            const common = roverEpoch.satellites.filter(s => commonSatIds.has(`${s.system}${s.prn}`));
            document.getElementById('commonSatCount').textContent = common.length;
            document.getElementById('commonGpsCount').textContent = common.filter(s => s.system === 'GPS').length;
            document.getElementById('commonBeidouCount').textContent = common.filter(s => s.system === 'BDS').length;
            document.getElementById('commonGlonassCount').textContent = common.filter(s => s.system === 'GLO').length;
            document.getElementById('commonGalileoCount').textContent = common.filter(s => s.system === 'GAL').length;

            renderTable(roverEpoch.satellites);
        }

        function drawSimplifiedSkyplot(canvasId, satellites, commonSatIds = null) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const dpr = window.devicePixelRatio || 1;
            
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            ctx.scale(dpr, dpr);
            
            const size = Math.min(rect.width, rect.height);
            const center = size / 2;
            const radius = center - 50;
            
            ctx.clearRect(0, 0, size, size);
            
            const isDark = document.documentElement.classList.contains('dark');
            const textColor = isDark ? '#9ca3af' : '#6b7280';
            const gridColor = isDark ? '#374151' : '#e5e7eb';
            const bgColor = isDark ? '#1f2937' : '#f9fafb';
            
            // Draw background
            ctx.beginPath();
            ctx.arc(center, center, radius, 0, Math.PI * 2);
            ctx.fillStyle = bgColor;
            ctx.fill();
            ctx.strokeStyle = gridColor;
            ctx.lineWidth = 2;
            ctx.stroke();

            // Draw inner circles for signal strength zones
            [0.33, 0.66].forEach(ratio => {
                ctx.beginPath();
                ctx.arc(center, center, radius * ratio, 0, Math.PI * 2);
                ctx.strokeStyle = gridColor;
                ctx.lineWidth = 1;
                ctx.setLineDash([4, 4]);
                ctx.stroke();
                ctx.setLineDash([]);
            });

            // Draw labels
            ctx.fillStyle = textColor;
            ctx.font = '10px system-ui';
            ctx.textAlign = 'center';
            ctx.fillText('>40 dB', center, center - radius * 0.15);
            ctx.fillText('30-40', center, center - radius * 0.5);
            ctx.fillText('<30 dB', center, center - radius * 0.85);

            // Group satellites by system
            const systems = ['GPS', 'BDS', 'GLO', 'GAL'];
            const satBySystem = {};
            systems.forEach(sys => satBySystem[sys] = satellites.filter(s => s.system === sys));

            // Draw satellites in a circular pattern grouped by system
            let totalDrawn = 0;
            const totalSats = satellites.length;

            systems.forEach((sys, sysIdx) => {
                const sysSats = satBySystem[sys];
                const baseAngle = (sysIdx / 4) * Math.PI * 2 - Math.PI / 2;
                const angleSpan = Math.PI / 2;

                sysSats.forEach((sat, i) => {
                    const avgCnr = sat.signals.reduce((sum, s) => sum + s.cnr, 0) / (sat.signals.length || 1);
                    
                    // Position based on signal strength (stronger = closer to center)
                    let r;
                    if (avgCnr >= 40) r = radius * 0.25;
                    else if (avgCnr >= 30) r = radius * 0.55;
                    else r = radius * 0.8;

                    // Angle within system quadrant
                    const angleOffset = sysSats.length > 1 
                        ? (i / (sysSats.length - 1) - 0.5) * angleSpan * 0.8
                        : 0;
                    const angle = baseAngle + angleOffset;

                    const x = center + r * Math.cos(angle);
                    const y = center + r * Math.sin(angle);

                    const isCommon = commonSatIds && commonSatIds.has(`${sat.system}${sat.prn}`);
                    const color = systemColors[sat.system];
                    
                    // Draw satellite dot
                    ctx.beginPath();
                    ctx.arc(x, y, isCommon ? 10 : 8, 0, Math.PI * 2);
                    ctx.fillStyle = color;
                    ctx.fill();

                    // Common satellite highlight
                    if (isCommon) {
                        ctx.beginPath();
                        ctx.arc(x, y, 13, 0, Math.PI * 2);
                        ctx.strokeStyle = '#22c55e';
                        ctx.lineWidth = 2;
                        ctx.stroke();
                    }

                    // Draw PRN label
                    ctx.fillStyle = isDark ? '#fff' : '#1f2937';
                    ctx.font = '9px system-ui';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'bottom';
                    ctx.fillText(`${sat.prn}`, x, y - 11);
                });
            });

            // Draw system labels around the edge
            const labelRadius = radius + 25;
            systems.forEach((sys, i) => {
                const angle = (i / 4) * Math.PI * 2 - Math.PI / 2;
                const x = center + labelRadius * Math.cos(angle);
                const y = center + labelRadius * Math.sin(angle);
                
                ctx.fillStyle = systemColors[sys];
                ctx.font = 'bold 11px system-ui';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(systemNames[sys], x, y);
            });
        }

        function renderSignalBars(satellites) {
            const container = document.getElementById('signalBars');
            if (!container) return;

            if (satellites.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-400 py-8">
                        <i class="fas fa-satellite-dish text-4xl mb-2 opacity-50"></i>
                        <p>当前历元无卫星数据</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = satellites.map(sat => {
                const color = systemColors[sat.system];
                const signals = sat.signals.slice(0, 3);
                const avgCnr = signals.reduce((sum, s) => sum + s.cnr, 0) / (signals.length || 1);
                const signalClass = avgCnr >= 40 ? 'bg-emerald-500' : (avgCnr >= 30 ? 'bg-amber-500' : 'bg-red-500');
                
                return `
                    <div class="flex items-center gap-2">
                        <div class="w-14 flex items-center gap-1">
                            <span class="w-2.5 h-2.5 rounded-full" style="background-color: ${color}"></span>
                            <span class="text-xs font-medium">${sat.system[0]}${sat.prn}</span>
                        </div>
                        <div class="flex-1">
                            <div class="flex gap-1 h-4">
                                ${signals.map(s => `
                                    <div class="flex-1 bg-gray-200 dark:bg-gray-700 rounded overflow-hidden">
                                        <div class="h-full ${s.cnr >= 40 ? 'bg-emerald-500' : (s.cnr >= 30 ? 'bg-amber-500' : 'bg-red-500')} transition-all" 
                                             style="width: ${Math.min(100, s.cnr * 2)}%"></div>
                                    </div>
                                `).join('')}
                                ${[...Array(3 - signals.length)].map(() => `
                                    <div class="flex-1 bg-gray-200 dark:bg-gray-700 rounded"></div>
                                `).join('')}
                            </div>
                        </div>
                        <div class="text-xs text-gray-500 dark:text-gray-400 w-16 text-right font-mono">
                            ${signals.map(s => s.cnr.toFixed(0)).join('/')}
                        </div>
                    </div>
                `;
            }).join('');

            // Update counts
            let good = 0, medium = 0, weak = 0;
            satellites.forEach(sat => {
                const avg = sat.signals.reduce((sum, s) => sum + s.cnr, 0) / (sat.signals.length || 1);
                if (avg >= 40) good++;
                else if (avg >= 30) medium++;
                else weak++;
            });
            
            const goodEl = document.getElementById('goodSignalCount');
            const medEl = document.getElementById('mediumSignalCount');
            const weakEl = document.getElementById('weakSignalCount');
            
            if (goodEl) goodEl.textContent = good;
            if (medEl) medEl.textContent = medium;
            if (weakEl) weakEl.textContent = weak;
        }

        function renderTable(satellites) {
            const tbody = document.getElementById('satelliteTableBody');
            if (!tbody) return;

            const filter = document.getElementById('systemFilter')?.value || 'all';
            const filtered = filter === 'all' ? satellites : satellites.filter(s => s.system === filter);

            if (filtered.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="px-4 py-8 text-center text-gray-400">
                            <p>暂无匹配的卫星数据</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = filtered.map(sat => {
                const color = systemColors[sat.system];
                const signals = sat.signals.slice(0, 3);
                const avgCnr = signals.reduce((sum, s) => sum + s.cnr, 0) / (signals.length || 1);
                
                const getSignalBadge = (cnr) => {
                    if (cnr === undefined || cnr === 0) return '<span class="text-gray-400">-</span>';
                    const colorClass = cnr >= 40 ? 'bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-400' :
                                      cnr >= 30 ? 'bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-400' :
                                                  'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400';
                    return `<span class="px-2 py-0.5 rounded text-xs font-medium ${colorClass}">${cnr.toFixed(1)}</span>`;
                };

                const qualityClass = avgCnr >= 40 ? 'bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-400' :
                                    avgCnr >= 30 ? 'bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-400' :
                                                  'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400';
                const qualityText = avgCnr >= 40 ? '良好' : (avgCnr >= 30 ? '一般' : '弱');
                
                return `
                    <tr class="table-row-hover border-b border-gray-100 dark:border-gray-800">
                        <td class="px-4 py-3 font-medium">${sat.system[0]}${sat.prn}</td>
                        <td class="px-4 py-3">
                            <span class="flex items-center gap-2">
                                <span class="w-3 h-3 rounded-full" style="background-color: ${color}"></span>
                                ${systemNames[sat.system]}
                            </span>
                        </td>
                        <td class="px-4 py-3 text-center">${getSignalBadge(signals[0]?.cnr)}</td>
                        <td class="px-4 py-3 text-center">${getSignalBadge(signals[1]?.cnr)}</td>
                        <td class="px-4 py-3 text-center">${getSignalBadge(signals[2]?.cnr)}</td>
                        <td class="px-4 py-3 text-center font-mono">${avgCnr.toFixed(1)}</td>
                        <td class="px-4 py-3 text-center">
                            <span class="px-2 py-0.5 rounded text-xs font-medium ${qualityClass}">${qualityText}</span>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function filterTable() {
            if (state.mode === 'single' && state.singleData) {
                const epoch = state.singleData[state.currentEpochIndex];
                if (epoch) renderTable(epoch.satellites);
            } else if (state.mode === 'dual' && state.roverData) {
                const epoch = state.roverData[state.currentEpochIndex];
                if (epoch) renderTable(epoch.satellites);
            }
        }

        // ============================================
        // Analysis Engine
        // ============================================
        function runAnalysis() {
            const epochs = state.mode === 'single' ? state.singleData : state.roverData;
            if (!epochs || epochs.length === 0) return;

            const analysis = analyzeData(epochs);
            renderAnalysisCards(analysis.issues);
            renderTrendChart(epochs);
        }

        function analyzeData(epochs) {
            const issues = [];
            
            // Calculate overall statistics
            const allSatellites = [];
            const cnrByEpoch = [];
            
            epochs.forEach((epoch, idx) => {
                const epochCnrs = [];
                epoch.satellites.forEach(sat => {
                    allSatellites.push(sat);
                    const avgCnr = sat.signals.reduce((sum, s) => sum + s.cnr, 0) / (sat.signals.length || 1);
                    epochCnrs.push(avgCnr);
                });
                cnrByEpoch.push({
                    index: idx,
                    avgCnr: epochCnrs.reduce((a, b) => a + b, 0) / (epochCnrs.length || 1),
                    count: epoch.satellites.length
                });
            });

            // Check satellite count
            const avgSatCount = cnrByEpoch.reduce((sum, e) => sum + e.count, 0) / cnrByEpoch.length;
            if (avgSatCount < 8) {
                issues.push({
                    type: 'warning',
                    icon: 'fa-satellite',
                    title: '卫星数量偏少',
                    description: `平均可见卫星 ${avgSatCount.toFixed(1)} 颗，建议 ≥ 8 颗以确保定位精度`,
                    suggestion: '检查天线安装位置是否有遮挡'
                });
            } else {
                issues.push({
                    type: 'success',
                    icon: 'fa-check-circle',
                    title: '卫星数量充足',
                    description: `平均可见卫星 ${avgSatCount.toFixed(1)} 颗，满足高精度定位需求`,
                    suggestion: ''
                });
            }

            // Check signal strength
            const avgOverallCnr = cnrByEpoch.reduce((sum, e) => sum + e.avgCnr, 0) / cnrByEpoch.length;
            if (avgOverallCnr < 30) {
                issues.push({
                    type: 'error',
                    icon: 'fa-signal',
                    title: '信号强度过弱',
                    description: `平均信噪比 ${avgOverallCnr.toFixed(1)} dB-Hz，低于推荐值 30 dB-Hz`,
                    suggestion: '检查天线连接、是否有电磁干扰源'
                });
            } else if (avgOverallCnr < 40) {
                issues.push({
                    type: 'warning',
                    icon: 'fa-signal',
                    title: '信号强度一般',
                    description: `平均信噪比 ${avgOverallCnr.toFixed(1)} dB-Hz，建议 ≥ 40 dB-Hz`,
                    suggestion: '信号可用，但可能影响 RTK 固定速度'
                });
            } else {
                issues.push({
                    type: 'success',
                    icon: 'fa-signal',
                    title: '信号强度良好',
                    description: `平均信噪比 ${avgOverallCnr.toFixed(1)} dB-Hz，信号质量优秀`,
                    suggestion: ''
                });
            }

            // Check signal stability
            const cnrVariance = cnrByEpoch.reduce((sum, e) => sum + Math.pow(e.avgCnr - avgOverallCnr, 2), 0) / cnrByEpoch.length;
            const cnrStdDev = Math.sqrt(cnrVariance);
            
            if (cnrStdDev > 5) {
                issues.push({
                    type: 'warning',
                    icon: 'fa-chart-line',
                    title: '信号波动较大',
                    description: `信号强度标准差 ${cnrStdDev.toFixed(2)} dB，存在明显波动`,
                    suggestion: '可能存在多路径效应或间歇性遮挡'
                });
            }

            // Check system diversity
            const currentEpoch = epochs[state.currentEpochIndex];
            const systemCounts = { GPS: 0, BDS: 0, GLO: 0, GAL: 0 };
            currentEpoch.satellites.forEach(sat => {
                if (systemCounts.hasOwnProperty(sat.system)) {
                    systemCounts[sat.system]++;
                }
            });
            
            const activeSystems = Object.values(systemCounts).filter(c => c > 0).length;
            if (activeSystems < 2) {
                issues.push({
                    type: 'info',
                    icon: 'fa-globe',
                    title: '系统多样性不足',
                    description: `仅接收到 ${activeSystems} 个卫星系统的信号`,
                    suggestion: '多系统组合有助于提高定位可靠性'
                });
            }

            // Check for potential RTK issues
            if (state.mode === 'dual' && state.baseData && state.roverData) {
                const baseEpoch = state.baseData[state.currentEpochIndex];
                const roverEpoch = state.roverData[state.currentEpochIndex];
                
                if (baseEpoch && roverEpoch) {
                    const baseSats = new Set(baseEpoch.satellites.map(s => `${s.system}${s.prn}`));
                    const roverSats = new Set(roverEpoch.satellites.map(s => `${s.system}${s.prn}`));
                    const commonCount = [...baseSats].filter(s => roverSats.has(s)).length;
                    
                    if (commonCount < 5) {
                        issues.push({
                            type: 'error',
                            icon: 'fa-link',
                            title: 'RTK 共视卫星不足',
                            description: `基站与测站共视卫星仅 ${commonCount} 颗，需要 ≥ 5 颗`,
                            suggestion: 'RTK 可能无法获得固定解'
                        });
                    } else if (commonCount < 8) {
                        issues.push({
                            type: 'warning',
                            icon: 'fa-link',
                            title: 'RTK 共视卫星较少',
                            description: `基站与测站共视卫星 ${commonCount} 颗`,
                            suggestion: '建议 ≥ 8 颗以提高 RTK 稳定性'
                        });
                    } else {
                        issues.push({
                            type: 'success',
                            icon: 'fa-link',
                            title: 'RTK 条件良好',
                            description: `基站与测站共视卫星 ${commonCount} 颗，满足 RTK 要求`,
                            suggestion: ''
                        });
                    }
                }
            }

            return { issues };
        }

        function renderAnalysisCards(issues) {
            const container = document.getElementById('analysisCards');
            if (!container) return;

            container.innerHTML = issues.map(issue => `
                <div class="analysis-card ${issue.type} bg-white dark:bg-dark-card rounded-xl p-5 border border-gray-200 dark:border-dark-border">
                    <div class="flex items-start gap-4">
                        <div class="w-10 h-10 rounded-lg flex items-center justify-center flex-shrink-0
                            ${issue.type === 'error' ? 'bg-red-100 dark:bg-red-900/30' : ''}
                            ${issue.type === 'warning' ? 'bg-amber-100 dark:bg-amber-900/30' : ''}
                            ${issue.type === 'success' ? 'bg-emerald-100 dark:bg-emerald-900/30' : ''}
                            ${issue.type === 'info' ? 'bg-blue-100 dark:bg-blue-900/30' : ''}">
                            <i class="fas ${issue.icon} 
                                ${issue.type === 'error' ? 'text-red-500' : ''}
                                ${issue.type === 'warning' ? 'text-amber-500' : ''}
                                ${issue.type === 'success' ? 'text-emerald-500' : ''}
                                ${issue.type === 'info' ? 'text-blue-500' : ''}"></i>
                        </div>
                        <div class="flex-1">
                            <h4 class="font-semibold text-gray-800 dark:text-gray-200">${issue.title}</h4>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">${issue.description}</p>
                            ${issue.suggestion ? `<p class="text-xs text-gray-500 dark:text-gray-500 mt-2"><i class="fas fa-lightbulb text-amber-400 mr-1"></i>${issue.suggestion}</p>` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function renderTrendChart(epochs) {
            const canvas = document.getElementById('trendChart');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            const dpr = window.devicePixelRatio || 1;
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            ctx.scale(dpr, dpr);

            const width = rect.width;
            const height = rect.height;
            const padding = { top: 20, right: 20, bottom: 30, left: 50 };
            const chartWidth = width - padding.left - padding.right;
            const chartHeight = height - padding.top - padding.bottom;

            const isDark = document.documentElement.classList.contains('dark');
            const gridColor = isDark ? '#374151' : '#e5e7eb';
            const textColor = isDark ? '#9ca3af' : '#6b7280';

            ctx.clearRect(0, 0, width, height);

            // Prepare data - group by system
            const systemData = { GPS: [], BDS: [], GLO: [], GAL: [] };
            const step = Math.max(1, Math.floor(epochs.length / 100)); // Limit to ~100 points

            for (let i = 0; i < epochs.length; i += step) {
                const epoch = epochs[i];
                const systemAvg = { GPS: [], BDS: [], GLO: [], GAL: [] };
                
                epoch.satellites.forEach(sat => {
                    const avgCnr = sat.signals.reduce((sum, s) => sum + s.cnr, 0) / (sat.signals.length || 1);
                    if (systemAvg[sat.system]) {
                        systemAvg[sat.system].push(avgCnr);
                    }
                });

                Object.keys(systemData).forEach(sys => {
                    const avg = systemAvg[sys].length > 0 
                        ? systemAvg[sys].reduce((a, b) => a + b) / systemAvg[sys].length 
                        : null;
                    systemData[sys].push({ x: i, y: avg });
                });
            }

            // Find y range
            let minY = 0, maxY = 55;

            // Draw grid
            ctx.strokeStyle = gridColor;
            ctx.lineWidth = 1;
            
            for (let i = 0; i <= 5; i++) {
                const y = padding.top + (chartHeight / 5) * i;
                ctx.beginPath();
                ctx.moveTo(padding.left, y);
                ctx.lineTo(width - padding.right, y);
                ctx.stroke();

                ctx.fillStyle = textColor;
                ctx.font = '11px system-ui';
                ctx.textAlign = 'right';
                ctx.textBaseline = 'middle';
                ctx.fillText((maxY - (maxY - minY) / 5 * i).toFixed(0), padding.left - 8, y);
            }

            // Draw y-axis label
            ctx.save();
            ctx.translate(15, height / 2);
            ctx.rotate(-Math.PI / 2);
            ctx.textAlign = 'center';
            ctx.fillText('CNR (dB-Hz)', 0, 0);
            ctx.restore();

            // Draw lines
            Object.entries(systemData).forEach(([sys, data]) => {
                const validData = data.filter(d => d.y !== null);
                if (validData.length < 2) return;

                ctx.beginPath();
                ctx.strokeStyle = systemColors[sys];
                ctx.lineWidth = 2;

                validData.forEach((point, idx) => {
                    const x = padding.left + (point.x / (epochs.length - 1)) * chartWidth;
                    const y = padding.top + chartHeight - ((point.y - minY) / (maxY - minY)) * chartHeight;
                    
                    if (idx === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                });

                ctx.stroke();
            });

            // Draw current position indicator
            const currentX = padding.left + (state.currentEpochIndex / (epochs.length - 1)) * chartWidth;
            ctx.beginPath();
            ctx.strokeStyle = isDark ? '#818cf8' : '#6366f1';
            ctx.lineWidth = 2;
            ctx.setLineDash([4, 4]);
            ctx.moveTo(currentX, padding.top);
            ctx.lineTo(currentX, height - padding.bottom);
            ctx.stroke();
            ctx.setLineDash([]);

            // Update legend
            const legend = document.getElementById('trendLegend');
            if (legend) {
                legend.innerHTML = Object.entries(systemColors).map(([sys, color]) => {
                    const hasData = systemData[sys].some(d => d.y !== null);
                    return hasData ? `
                        <div class="flex items-center gap-2">
                            <span class="w-4 h-1 rounded" style="background-color: ${color}"></span>
                            <span>${systemNames[sys]}</span>
                        </div>
                    ` : '';
                }).join('');
            }
        }

        // ============================================
        // Theme & Initialization
        // ============================================
        const themeToggle = document.getElementById('themeToggle');
        const html = document.documentElement;
        
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            html.classList.add('dark');
        }
        
        themeToggle.addEventListener('click', () => {
            html.classList.toggle('dark');
            localStorage.theme = html.classList.contains('dark') ? 'dark' : 'light';
            // Redraw charts
            if (state.singleData || state.baseData) {
                renderCurrentEpoch();
                runAnalysis();
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Setup drag and drop
            setupDragDrop('uploadZone', 'fileInput', handleFileSelect);
            setupDragDrop('baseUploadZone', 'baseFileInput', handleBaseFileSelect);
            setupDragDrop('roverUploadZone', 'roverFileInput', handleRoverFileSelect);
            
            // Trigger animations
            document.querySelectorAll('.opacity-0').forEach(el => {
                el.classList.remove('opacity-0');
            });
        });

        // Handle resize
        window.addEventListener('resize', () => {
            if (state.singleData || state.baseData) {
                renderCurrentEpoch();
                runAnalysis();
            }
        });
        
        // Theme change redraw
        const observer = new MutationObserver(() => {
            if (state.singleData || state.baseData) {
                renderCurrentEpoch();
                runAnalysis();
            }
        });
        observer.observe(document.documentElement, { attributes: true, attributeFilter: ['class'] });
    </script>
</body>
</html>

